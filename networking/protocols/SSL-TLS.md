## SSL (Secure Sockets Layer)

Standard technology for keeping an internet connection secure, safeguarding sensitive data that is being sent via packets between two systems, and preventing attackers from reading and modifying data that is transferred. Data exchange applies between client to client, client to server, and server to server. Browsers will only trust SSL certificates issued by authorized issuers (Certificate Authorities) such as DigiCert. For organizations that want to offer services encrypted by TLS, they have to prove to CAs of their legitimacy and that they control the domain.

### How SSL Works

Encryption uses asymmetrical cryptography which requires public and private keys. Both keys are related to each other by complex mathematical formula that is difficult to reverse-engineer by brute force.

## Self-Signed vs CA (Certificate Authority)

|            | Self-Signed                                                                                | CA                                                                                                                 |
| ---------- | ------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------ |
| Definition | Created, signed, and issued by the subject of the certificate (the entity it is issued to) | Created, signed and issued by a third party called CA that is authorized to validate the identity of the applicant |
| Usage      | Private networks/Intranet                                                                  | Public networks to build trust among website visitors                                                              |
| Signature  | Signed by your own private keys                                                            | Signed by third parties including Sectigo, Symantec, Digicert, Thawte, GeoTrust, GlobalSign, GoDaddy, and Entrust  |

## TLS (Transport Layer Security)

An updated, more secure version of SSL (SSL successor). Asymmetrical cryptography requires significant computing resources; encrpyting all information would be expensive. TLS gets around this by using it at beginning of communications session whereby the server and client agrees on single session key that will be used to encrypt packets from that point forward. Session/shared key is established using asymmetrical cryptography, and data is encrypted with shared key which uses symmetrical crpytography and is much less computationally intensive. Session keys are only used once.

## Protocol Versions

```
SSL v2      Has serious security vulnerabilities
SSL v3      Has serious security vulnerabilities
TLS 1.0     Does not support modern cipher suites
TLS 1.2     Recommended version
TLS 1.3
```

## HTTPS

Hyper Text Transfer Protocol secure. Appears in URL when a website is secured by an SSL/TLS certificate.

## TLS Handshake

A TLS handshake occurs whenever a user navigates to a website over HTTPS. Also happens whenever any other communications use HTTPS, including API calls and DNS over HTTPS queries.

### Actions

During the course of a TLS handshake, the client and server together will perform the following:

- Specify which version of TLS (1.0, 1.2, 1.3) they will use
- Decide on which cipher suites they will use
- Authenticate the identity of the server via server's public key and the SSL certificate authority's digital signature
- Generate session keys in order to use symmetric encryption after the handshake is complete

### Steps

1. **The 'client hello' message**: Client initiates the shandshake by sending a "hello" message to the server. Message includes which TLS version the client supports, the cipher suites supported, and a string of random bytes known as the "client random".
2. **The 'server hello' message**: Server sends a message containing the server's SSL certificate, the server's chosen cipher suite, and the "server's random", another random string of bytes generated by the server.
3. **Authentication**: Client verifies the server's SSL certificate with the certificate authority that issued it.
4. **The premaster secret**: Client sends one more random string of bytes that is encrypted with the public key and can only be decrypted with the private key by the server (client gets the public key from the server's SSL certificate).
5. **Decryption**: Server decrypts the premaster secret with private key.
6. **Session keys generated**: Both client and server generate session keys from the client random, server random, and the premaster secret.
7. **Client is ready**: Client sends a "finished" message that is encrypted with a session key.
8. **Server is ready**: Server sends a "finished" message encrypted with a session key.
9. **Secure symmetric encryption achieved**: The handshake is completed, and subsequent communication uses the session keys.

## CA Certificates

CA Bundle is the file that contains root and intermediate certificates i.e. issued for server's domain. The chain is required to improve the compatibility of the certificates with web browsers, email clients and mobile devices.

A missing intermediate is one of the most common causes of SSL connection errors. To avoid this issue, need to **import the right file**, and the certificates **must be in the correct order**.

To extract certificate from browser, the certificate can be downloaded in .pem format. Can also be done with openssl.

```
# Locations of crt in Linux
/etc/cert-bundle.crt
/etc/pki/tls/certs/ca-bundle.crt
/etc/ssl/certs
```

### ca-bundle.crt

Contains a list of CA certificates trusted for TLS server authentication usage without distrust information.

### ca-bundle.trust.crt

Contains a list of CA certificates which includes trust (and/or distrust) flags specific to certificate usage. Has extendede BEGIN/END TRUSTED CERTIFICATE file format.

### Creating CA Bundle

When your domain has been validated by CA, you will receive an SSL certificate (yourdomain.crt), a root certificate and intermediate certificates.

The CA bundle file should contain codes in the following order:

1. Intermediate CA Certificate 2
2. Intermediate CA Certificate 1
3. Root CA Certificate

Save the file as ca-bundle.crt, and paste the file in CABUNDLE field on your server.

### Certificate Verification (curl)

libcurl performs peer SSL certificate validation by default. This is done by using a CA certificate store that the SSL library can use.

Verification will fail for the following:

- The remote server uses a self-signed certifiate
- No CA cert store is installed
- Server uses a cert signed by a CA that is not included in the store

To successfully validate, can perform the following:

- Ignore verification with --insecure
- Add CA cert for your server to the existing default CA cert store. Can be changed at compile time with configure options of --with-ca-bundle=FILE or --with-ca-path=PATH (files must be concatenated in PEM format)

### Installing in CA Trust Store

To install a certificate in the trust store, it must be in PEM format i.e. BEGIN CERTIFICATE and END CERTIFICATE in human-readable format.

```console
$ sudo apt-get install -y ca-certificates
$ sudo cp your-ca.crt /usr/local/share/ca-certificates
$ sudo update-ca-certificates
```

CA trust store generated by update-ca-certificates is available at:

- /etc/ssl/certs/ca-certificates.crt (single PEM bundle, includes both certificates provided by distribution and user-added)
- /etc/ssl/certs (as an OpenSSL directory)

### ENV Variables

```
CURL_CA_BUNDLE      For curl, specify own CA cert file
REQUESTS_CA_BUNDLE  For Python requests
```
