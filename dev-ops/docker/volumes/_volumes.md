## Volumes

Volumes are the preferred mechanism for persistent data generated by and used by Docker containers. When a container is started, Docker loads the read-only image layer, adds a read-write layer on top of the image stack, and mounts volumes on the container filesystem.

Containers are usually immutable (to change, only re-deploy). However, databases are not, and Docker gives features to ensure 'separation of concerns'. Two ways to solve it: Volumes and Bind Mounts that will outlive the executable. Volumes make special location outside of container Union File System. Bind Mounts link container path to host path i.e. maps files from host directory into a directory in the container. When container gets deleted, volume does not get automatically deleted.

```console
$ docker volume create [OPTIONS] [VOLUME]

$ docker volume create my-vol
$ docker volume ls
$ docker volume inspect my-vol
$ docker volume rm my-vol

$ docker volume rm <vol_name1> <vol_name2>
$ docker volume prune    # removes all volumes not used by at least 1 container
```

## Bind Mounts

A Docker bind mount is a high-performance connection from the container to a directory on the host machine i.e. uses the host file system. It allows the host to share its own file system with the container, which can be made read-only or read-write.

```console
# pwd is the source on the host
# /var/opt/project is the target mount point of the container
# after running, file.txt will exist in the pwd of our host machine

$ docker run -v $(pwd):/var/opt/project bash:latest \
  bash -c "echo Hello > /var/opt/project/file.txt"
```

## Docker Volumes

Docker volumes are native to Docker. Data is kept somewhere on storage attached to the host (often the local filesystem) but is not usable by the host directly. Volumes can be shared between containers. Volume itself has a lifecycle that is longer than the container's.

Using the -v command contains three components:

- Source directory or volume name
- Mount point within the container
- ro if the mount is to be read-only (optional)

When a host folder is mounted onto the container's path, all the content will be available in the container's path. **This is needed if the container needs to read a file from host, or to write to host's directory**.

```console
$ docker run -v /folder/with/files:/container/path image_name

$ docker run -v $(pwd):/var/opt/project bash:latest \
  bash -c "ls /var/opt/project"
```

### Host-mounted Volumes

Host path can be defined as an absolute or as relative path. By default, the volumes are created inside the local host directory. Hence, don't have to specify the host directory.

```
Linux                   /var/lib/docker/volume
Windows without WSL     C:\ProgramData\Docker\volumes\
Windows with WSL        \\wsl$\docker-desktop-data\data\docker\volumes
```

```
/host/path:/container/path

/var/lib/mysql
/var/opt/my_website/dist:/usr/share/nginx/html:ro
```

### Implicit Docker Volume

Internal volumes have the scope of a single Docker-compose file. If the source is a name, Docker tries to find the volume and creates if it doesn't exist.

```console
$ docker run -it --rm --name nginx -p 8080:80 -v demo-earthly:/usr/share/nginx/html nginx
```

### Explicit Docker Volume

External volumes can be used across the Docker installation and they need to be created by the user (otherwise fails) using the "docker volume create" command.

```console
$ docker volume create --name demo-earthly
```

### Declaring Volume from Dockerfile

Statement declares that a specific path of the container must be mounted to a Docker volume. When the container is run, Docker will create an anonymous volume (with unique id) and mount it to the specified path.

```dockerfile
FROM nginx:latest

RUN echo "<h1>Hello from Volume</h1>" > /usr/share/nginx/html/index.html
VOLUME /usr/share/nginx/html
```

### Mounting Volume to Container

```
type                "volume" to indicate a volume mount
src                 name of volume or source directory
dst                 destionation mount point in the container
volume-driver
readonly            rw for read/write
```

```console
$ docker run --mount source=[volume_name],destination=[path_in_container] [docker_image]

$ docker run -it --name=example --mount source=demo-volume,destination=/data ubuntu

$ docker run --mount \
  'type=volume,src=data-volume,\
  dst=/var/opt/project,volume-driver=local,\
  readonly' \
  bash -c "ls /var/opt/project"
```

### Using Docker Compose

Multiple services can share the same volume; a named volumed MUST be declared in the top-level volumes key.

```yaml
version: "3.2"
services:
  web:
    image: nginx:latest
    ports:
      - 8080:80
    volumes:
      # mount ./target from host to /usr/share/nginx/html of the container (mount point)
      - ./target:/usr/share/nginx/html
  web1:
    image: nginx:latest
    ports:
      - 8081:80
    volumes:
      - html_files:/usr/share/nginx/html
volumes:
  html_files:
```
